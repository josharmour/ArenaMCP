---
phase: 03-external-data
plan: 01
type: execute
---

<objective>
Integrate Scryfall card database with bulk data caching and API fallback for arena_id lookups.

Purpose: Enable card oracle text, type, and rules lookup from grp_id values tracked by GameState.
Output: ScryfallCache class providing get_card_by_arena_id() with local caching and rate-limited API fallback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./03-01-summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-game-state/02-01-SUMMARY.md

@src/arenamcp/gamestate.py

**Tech stack available:** Python, dataclasses, watchdog
**Established patterns:** Dataclass containers, factory functions, streaming parser

**Constraining decisions:**
- Phase 02-01: grp_id values tracked in GameObject, maps directly to Scryfall arena_id

**From discovery (Level 1):**
- Scryfall bulk data API: `GET https://api.scryfall.com/bulk-data`
- "Default Cards" file (~500MB JSON) contains arena_id field on each card object
- Direct lookup fallback: `GET https://api.scryfall.com/cards/arena/:id`
- Rate limit: 10 requests/sec (100ms delay between requests)
- arena_id is nullable integer - many cards not on Arena
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScryfallCache with bulk data download and arena_id index</name>
  <files>src/arenamcp/scryfall.py, requirements.txt</files>
  <action>
Create ScryfallCache class that:
1. Downloads bulk data manifest from https://api.scryfall.com/bulk-data
2. Finds "default_cards" entry and downloads the JSON file to local cache directory
3. Parses JSON and builds dict mapping arena_id (int) -> card object
4. Stores parsed index in memory, raw JSON in ~/.arenamcp/cache/scryfall/
5. Checks file age on init - re-download if older than 24 hours
6. Use requests library for HTTP (add to requirements.txt)

Card object should be a dataclass with fields: name, oracle_text, type_line, mana_cost, cmc, colors, arena_id, scryfall_uri

Do NOT use scrython library - it's abandoned and has issues. Use requests directly.
Store cache in user home directory (~/.arenamcp/cache/) not project directory.
  </action>
  <verify>
python -c "from arenamcp.scryfall import ScryfallCache; c = ScryfallCache(); print(f'Loaded {len(c._arena_index)} cards')"
Should print "Loaded NNNNN cards" with >20000 count (first run downloads ~500MB, may take 30-60 seconds)
  </verify>
  <done>ScryfallCache initializes with populated arena_id index, cache file persists between runs</done>
</task>

<task type="auto">
  <name>Task 2: Implement get_card_by_arena_id with cache lookup and rate-limited API fallback</name>
  <files>src/arenamcp/scryfall.py, src/arenamcp/__init__.py</files>
  <action>
Add to ScryfallCache:
1. get_card_by_arena_id(arena_id: int) -> Optional[ScryfallCard]
2. First check _arena_index dict
3. If not found, call API: GET https://api.scryfall.com/cards/arena/{arena_id}
4. Rate limit API calls: track last_api_call timestamp, enforce 100ms minimum gap
5. On API success, add to _arena_index for session (don't rewrite bulk file)
6. On API 404, return None
7. Handle network errors gracefully - log warning, return None

Export ScryfallCache and ScryfallCard from arenamcp __init__.py
  </action>
  <verify>
python -c "from arenamcp import ScryfallCache; c = ScryfallCache(); card = c.get_card_by_arena_id(67330); print(f'{card.name}: {card.type_line}')"
Should print "Yargle, Glutton of Urborg: Legendary Creature â€” Frog Spirit" (arena_id 67330 is Yargle)
  </verify>
  <done>get_card_by_arena_id returns ScryfallCard for valid IDs, None for invalid, API fallback works with rate limiting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from arenamcp import ScryfallCache"` imports without error
- [ ] Cache directory exists at ~/.arenamcp/cache/scryfall/
- [ ] get_card_by_arena_id(67330) returns Yargle card data
- [ ] get_card_by_arena_id(999999999) returns None (invalid ID)
- [ ] Existing tests still pass: `pytest tests/`
</verification>

<success_criteria>

- ScryfallCache class with bulk data download and caching
- arena_id index with >20000 cards loaded
- get_card_by_arena_id() working with cache + API fallback
- Rate limiting enforced on API calls
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-external-data/03-01-SUMMARY.md`
</output>
