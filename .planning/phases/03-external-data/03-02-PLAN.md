---
phase: 03-external-data
plan: 02
type: execute
---

<objective>
Integrate 17lands draft statistics for card evaluation during limited play.

Purpose: Provide GIH WR, ALSA, and IWD metrics for draft card evaluation via MCP tools.
Output: DraftStatsCache class providing get_draft_rating() for card name + set code lookup.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./03-02-summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-external-data/03-01-SUMMARY.md

@src/arenamcp/scryfall.py

**Tech stack available:** Python, dataclasses, requests
**Established patterns:** Cache classes, dataclass containers

**From discovery (Level 1):**
- 17lands public datasets at https://www.17lands.com/card_ratings/data?expansion={SET}&format=PremierDraft
- CSV columns: Name, Color, Rarity, # Seen, ALSA, # Picked, ATA, # GP, GP WR, # OH, OH WR, # GD, GD WR, # GIH, GIH WR, # GNS, GNS WR, IWD
- GIH WR = Games in Hand Win Rate (primary metric)
- ALSA = Average Last Seen At (wheeling indicator)
- IWD = Improvement When Drawn (card quality signal)
- Data shows NA/0% for cards with <500 samples
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DraftStatsCache with CSV download and parsing</name>
  <files>src/arenamcp/draftstats.py</files>
  <action>
Create DraftStatsCache class that:
1. Downloads card ratings from https://www.17lands.com/card_ratings/data?expansion={SET}&format=PremierDraft
2. Parses CSV response (use csv module, not pandas - keep deps minimal)
3. Stores data in memory keyed by (set_code, card_name.lower())
4. Caches raw CSV files to ~/.arenamcp/cache/17lands/{SET}_PremierDraft.csv
5. Check file age on load - re-download if older than 24 hours
6. Load on demand: only fetch set data when first requested

DraftStats dataclass with fields: name, set_code, gih_wr (float or None), alsa (float or None), iwd (float or None), games_in_hand (int)

Handle NA values by storing None. Parse percentages like "55.2%" to 0.552 floats.
  </action>
  <verify>
python -c "from arenamcp.draftstats import DraftStatsCache; c = DraftStatsCache(); print('DraftStatsCache initialized')"
Should print without error
  </verify>
  <done>DraftStatsCache class exists with CSV parsing logic, cache directory structure</done>
</task>

<task type="auto">
  <name>Task 2: Implement get_draft_rating with card name + set code lookup</name>
  <files>src/arenamcp/draftstats.py, src/arenamcp/__init__.py</files>
  <action>
Add to DraftStatsCache:
1. get_draft_rating(card_name: str, set_code: str) -> Optional[DraftStats]
2. Normalize card_name to lowercase for lookup
3. If set not loaded, download and parse CSV first
4. Return DraftStats if found, None otherwise
5. Handle network errors gracefully - log warning, return None

Also add load_set(set_code: str) method to pre-load a set's data.

Export DraftStatsCache and DraftStats from arenamcp __init__.py

Common set codes: DSK (Duskmourn), BLB (Bloomburrow), OTJ (Outlaws), MKM (Murders), LCI (Lost Caverns)
  </action>
  <verify>
python -c "from arenamcp import DraftStatsCache; c = DraftStatsCache(); stats = c.get_draft_rating('Shock', 'DSK'); print(f'Shock GIH WR: {stats.gih_wr if stats else \"Not found\"}' if stats else 'Set may not have Shock')"
Should print GIH WR value or "Not found" (depends on whether Shock is in Duskmourn)
  </verify>
  <done>get_draft_rating returns DraftStats for valid cards, None for invalid, lazy loading works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from arenamcp import DraftStatsCache"` imports without error
- [ ] Cache directory exists at ~/.arenamcp/cache/17lands/
- [ ] get_draft_rating() returns stats for known cards in recent sets
- [ ] get_draft_rating() returns None for invalid card/set combos
- [ ] Existing tests still pass: `pytest tests/`
</verification>

<success_criteria>

- DraftStatsCache class with CSV download and parsing
- Lazy loading: only fetches set data when requested
- get_draft_rating() working with card name + set code
- GIH WR, ALSA, IWD metrics parsed correctly
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-external-data/03-02-SUMMARY.md`
</output>
