---
phase: 08-mcp-voice-tools
plan: 01
type: execute
---

<objective>
Expose voice coaching capabilities as MCP tools for any client.

Purpose: Enable any MCP client (Claude Code, custom apps) to use voice input/output without managing audio directly. The server handles all voice I/O through simple tool calls.
Output: Three new MCP tools: listen_for_voice(), speak_advice(), get_pending_advice()
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (voice components)
@.planning/phases/05-voice-input/05-03-SUMMARY.md
@.planning/phases/06-voice-output/06-01-SUMMARY.md
@.planning/phases/07-coach-engine/07-01-SUMMARY.md

# Key source files
@src/arenamcp/server.py
@src/arenamcp/voice.py
@src/arenamcp/tts.py
@src/arenamcp/coach.py
@src/arenamcp/__init__.py

**Tech stack available:**
- VoiceInput (PTT/VOX with Whisper transcription)
- VoiceOutput (Kokoro TTS with speak/speak_async/stop)
- CoachEngine (LLM backends with game context formatting)
- GameStateTrigger (proactive advice detection)

**Established patterns:**
- MCP tools via @mcp.tool() decorator returning dict[str, Any]
- Lazy initialization for expensive resources (_scryfall, _draft_stats pattern)
- Module-level state instances for shared components

**Constraining decisions:**
- STDIO transport (tools must be synchronous or handle async internally)
- Tools return JSON-serializable dicts
- Graceful degradation on errors (return error dict, don't raise)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add listen_for_voice and speak_advice MCP tools</name>
  <files>src/arenamcp/server.py</files>
  <action>
Add two new MCP tools to server.py:

1. **listen_for_voice(mode, timeout)** tool:
   - Parameters: mode ("ptt" or "vox", default "ptt"), timeout (float, optional)
   - Creates VoiceInput instance (lazy, module-level like _scryfall pattern)
   - Calls start(), wait_for_speech(timeout), stop() sequence
   - Returns {"transcription": text, "mode": mode} on success
   - Returns {"error": message} on failure/timeout
   - PTT mode uses F4 hotkey (established in voice.py)
   - VOX mode uses default threshold (0.02)

2. **speak_advice(text)** tool:
   - Parameter: text (str) - text to synthesize and speak
   - Creates VoiceOutput instance (lazy, module-level)
   - Calls speak(text, blocking=True) - blocks until playback complete
   - Returns {"spoken": True, "text": text} on success
   - Returns {"error": message} if TTS fails (e.g., missing model files)
   - Catch FileNotFoundError from KokoroTTS and return helpful error

Add module-level lazy loaders following established pattern:
```python
_voice_input: Optional[VoiceInput] = None
_voice_output: Optional[VoiceOutput] = None

def _get_voice_input() -> VoiceInput:
    ...

def _get_voice_output() -> VoiceOutput:
    ...
```

Import VoiceInput from arenamcp.voice, VoiceOutput from arenamcp.tts.
  </action>
  <verify>python -c "from arenamcp.server import listen_for_voice, speak_advice; print('Tools imported')"</verify>
  <done>listen_for_voice and speak_advice tools exist, import without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add advice queue and get_pending_advice tool</name>
  <files>src/arenamcp/server.py</files>
  <action>
Add advice queue infrastructure and tool for proactive coaching:

1. **Module-level advice queue:**
   - Use collections.deque for thread-safe FIFO queue
   - `_pending_advice: deque[dict[str, Any]] = deque(maxlen=10)`
   - Capped at 10 items to prevent memory growth

2. **queue_advice(advice, trigger)** internal function:
   - Adds {"advice": str, "trigger": str, "timestamp": float} to queue
   - Uses time.time() for timestamp
   - Called by background loop (Phase 9) when triggers fire

3. **get_pending_advice()** MCP tool:
   - No parameters
   - Pops all items from _pending_advice queue (drain pattern)
   - Returns {"advice_items": [...], "count": N}
   - Returns {"advice_items": [], "count": 0} if queue empty
   - Each item has: advice (str), trigger (str), timestamp (float)

4. **clear_pending_advice()** MCP tool:
   - Clears the queue without returning items
   - Returns {"cleared": True, "count": N} where N is items cleared
   - Useful for clients that want to reset state

Import: from collections import deque, import time
  </action>
  <verify>python -c "from arenamcp.server import get_pending_advice, clear_pending_advice, queue_advice; print('Queue tools imported')"</verify>
  <done>get_pending_advice and clear_pending_advice tools exist, queue_advice function available for Phase 9</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from arenamcp.server import listen_for_voice, speak_advice, get_pending_advice, clear_pending_advice"` succeeds
- [ ] `python -c "from arenamcp.server import queue_advice"` succeeds (internal function for Phase 9)
- [ ] `python -c "from arenamcp import mcp; print([t.name for t in mcp._tools.values()])"` shows all 8 tools
- [ ] No import errors when loading server module
</verification>

<success_criteria>

- listen_for_voice tool blocks until voice captured, returns transcription
- speak_advice tool synthesizes and plays text via TTS
- get_pending_advice tool drains advice queue
- clear_pending_advice tool clears queue
- queue_advice function available for Phase 9 integration
- All tools follow established error handling pattern (return error dict)
- No regressions in existing tools (get_game_state, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/08-mcp-voice-tools/08-01-SUMMARY.md`:

# Phase 8 Plan 1: MCP Voice Tools Summary

**[Substantive one-liner about what was built]**

## Performance

- **Duration:** X min
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments

- [Key outcomes]

## Task Commits

Each task was committed atomically:

1. **Task 1: [name]** - `hash` (feat)
2. **Task 2: [name]** - `hash` (feat)

## Files Created/Modified

- `src/arenamcp/server.py` - Added 4 new MCP tools for voice coaching

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Any changes from the plan, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 8 complete. Ready for Phase 9: Integration.

- Voice MCP tools ready for any client
- queue_advice() ready for background loop to push proactive triggers
- All voice I/O encapsulated in simple tool calls

---
*Phase: 08-mcp-voice-tools*
*Completed: YYYY-MM-DD*
</output>
