---
phase: 01-foundation
plan: 01
type: execute
---

<objective>
Set up Python project structure and implement real-time log watcher for MTGA Player.log.

Purpose: Establish the foundational file watching infrastructure that all subsequent parsing depends on.
Output: Working log watcher that detects Player.log changes and handles Windows file locking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Key technical details from design doc:**
- Log path: `%AppData%\LocalLow\Wizards Of The Coast\MTGA\Player.log`
- Uses watchdog library for file system events
- Must handle Windows file locking (MTGA holds file open)
- Must handle log truncation on MTGA restart (reset position to 0)
- Reference implementations: mtga-pro-tracker, 17lands mtga-log-client
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python project structure</name>
  <files>pyproject.toml, src/arenamcp/__init__.py, src/arenamcp/watcher.py</files>
  <action>
Create a minimal Python project using pyproject.toml with:
- Name: arenamcp
- Python >=3.10
- Dependencies: watchdog
- src layout: src/arenamcp/

Create empty __init__.py and watcher.py placeholder.

Use modern pyproject.toml format (not setup.py). Include a [project.scripts] entry for `arenamcp` CLI if needed later.
  </action>
  <verify>pip install -e . succeeds in the project directory</verify>
  <done>Project installs as editable package, imports work: `python -c "import arenamcp"`</done>
</task>

<task type="auto">
  <name>Task 2: Implement log watcher with watchdog</name>
  <files>src/arenamcp/watcher.py</files>
  <action>
Implement MTGALogWatcher class using watchdog.observers.Observer:

1. FileSystemEventHandler subclass that:
   - Tracks file_position (byte offset for incremental reads)
   - On on_modified: seek to position, read new content, update position
   - On on_created: reset file_position to 0 (handles log truncation on MTGA restart)

2. MTGALogWatcher class:
   - __init__(log_path: str, callback: Callable[[str], None])
   - start() method that creates Observer, schedules handler, starts watching
   - stop() method for clean shutdown
   - Default log_path from MTGA_LOG_PATH env var or standard Windows location

3. Handle Windows file locking:
   - Open file with encoding='utf-8' and errors='replace' (log has occasional encoding issues)
   - Use 'r' mode (not 'rb') for text processing
   - Handle FileNotFoundError gracefully (MTGA not running)

4. Callback receives raw text chunks (not parsed) - parser layer will handle structure.

Reference watchdog pattern from design doc but ensure robust error handling.
  </action>
  <verify>
Create test script that:
```python
from arenamcp.watcher import MTGALogWatcher
watcher = MTGALogWatcher(callback=lambda x: print(f"Got {len(x)} chars"))
watcher.start()
# Manually append to a test log file, verify callback fires
```
  </verify>
  <done>
- Watcher detects file modifications and delivers new content via callback
- File position tracking prevents re-reading old content
- Log truncation (file recreation) resets position correctly
- Clean start/stop lifecycle
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e .` succeeds
- [ ] `python -c "from arenamcp.watcher import MTGALogWatcher"` imports without error
- [ ] Manual test with fake log file shows callback receiving incremental content
- [ ] No watchdog deprecation warnings
</verification>

<success_criteria>
- Project structure matches src layout convention
- MTGALogWatcher class exists with start/stop/callback interface
- File position tracking works for incremental reads
- Ready for log parser to consume raw text chunks
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
