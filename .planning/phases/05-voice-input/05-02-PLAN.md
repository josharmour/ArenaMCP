---
phase: 05-voice-input
plan: 02
type: execute
---

<objective>
Implement push-to-talk (PTT) and voice activation (VOX) trigger mechanisms.

Purpose: Provide two input modes - manual hotkey control and automatic voice detection - for flexible voice capture.
Output: PTT handler with F4 global hotkey and VOX detector with configurable threshold.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/arenamcp/audio.py (from 05-01)

**Prior plan context:**
- 05-01 created AudioRecorder with start_recording/stop_recording API
- Audio is 16kHz float32 mono numpy arrays

**Tech decisions:**
- keyboard library for global hotkeys (works without focus on Windows)
- RMS (root mean square) for voice activity detection
- F4 as default PTT key (gaming-friendly, not commonly used)
- VOX threshold ~0.02 RMS for typical speech (configurable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PTT handler with global hotkey</name>
  <files>pyproject.toml (or requirements.txt), src/arenamcp/triggers.py</files>
  <action>
Add keyboard library to dependencies.

Create src/arenamcp/triggers.py with:

PTTHandler class:
- __init__(hotkey: str = 'f4', on_start: Callable = None, on_stop: Callable = None)
- start(): Register global hotkey listener using keyboard.on_press_key and keyboard.on_release_key
- stop(): Unregister hotkey listener using keyboard.unhook_all()
- _on_press(event): Call on_start callback if provided
- _on_release(event): Call on_stop callback if provided

Use keyboard library's hook mechanism - it captures globally without window focus.

IMPORTANT: keyboard library requires admin/root on Linux but works normally on Windows. Document this in docstring.
  </action>
  <verify>
python -c "
from arenamcp.triggers import PTTHandler
triggered = []
ptt = PTTHandler(hotkey='f4', on_start=lambda: triggered.append('start'), on_stop=lambda: triggered.append('stop'))
ptt.start()
print('PTT handler started, F4 hotkey registered')
print('Press F4 to test (or skip with Ctrl+C)')
import time
try:
    time.sleep(2)
except KeyboardInterrupt:
    pass
ptt.stop()
print(f'Triggers received: {triggered}')
print('OK')
"
  </verify>
  <done>PTTHandler registers F4 global hotkey, fires callbacks on press/release</done>
</task>

<task type="auto">
  <name>Task 2: Create VOX detector with RMS threshold</name>
  <files>src/arenamcp/triggers.py</files>
  <action>
Add to triggers.py:

VOXDetector class:
- __init__(threshold: float = 0.02, on_voice_start: Callable = None, on_voice_stop: Callable = None, silence_duration: float = 1.0)
- process_audio(audio_chunk: np.ndarray) -> bool: Calculate RMS, detect voice activity
- _calculate_rms(audio: np.ndarray) -> float: Return sqrt(mean(audio**2))
- reset(): Reset internal state

Internal state:
- _is_speaking: bool - currently detecting voice
- _silence_start: Optional[float] - when silence began (for silence_duration cutoff)

Logic:
- If RMS > threshold and not speaking: trigger on_voice_start, set _is_speaking=True
- If RMS < threshold and speaking: start silence timer
- If silence timer exceeds silence_duration: trigger on_voice_stop, set _is_speaking=False
- If RMS > threshold while in silence grace period: cancel timer, stay speaking

This provides hysteresis to avoid choppy detection on natural speech pauses.
  </action>
  <verify>
python -c "
import numpy as np
from arenamcp.triggers import VOXDetector

events = []
vox = VOXDetector(
    threshold=0.02,
    on_voice_start=lambda: events.append('start'),
    on_voice_stop=lambda: events.append('stop'),
    silence_duration=0.3
)

# Simulate speech: loud, quiet, loud, then sustained silence
loud = np.random.randn(1600) * 0.1  # ~0.1 RMS
quiet = np.random.randn(1600) * 0.005  # ~0.005 RMS

vox.process_audio(loud)  # Should start
vox.process_audio(quiet)  # Brief pause
vox.process_audio(loud)  # Still speaking
for _ in range(5):
    vox.process_audio(quiet)  # Sustained silence -> should stop

print(f'Events: {events}')
assert 'start' in events, 'Voice start not detected'
assert 'stop' in events, 'Voice stop not detected'
print('OK')
"
  </verify>
  <done>VOXDetector detects voice activity via RMS threshold with silence grace period</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from arenamcp.triggers import PTTHandler, VOXDetector"` succeeds
- [ ] PTT hotkey registers and fires callbacks
- [ ] VOX detector triggers on loud audio, stops after silence
</verification>

<success_criteria>
- PTTHandler with global F4 hotkey (works without window focus)
- VOXDetector with RMS-based voice activity detection
- Both use callback pattern for integration flexibility
- Silence grace period prevents choppy VOX behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05-voice-input/05-02-SUMMARY.md`
</output>
