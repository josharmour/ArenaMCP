# Bug Fixes - 2026-02-06

## Bugs Identified from bug_20260206_161014.json

### Bug #1: Misleading Mana Pool Display for Dual Lands
**Problem:** Temple of Mystery was displayed as "Mana: 1 (U:1 G:1)" making it look like you have both U and G available simultaneously, when in reality you have 1 source that produces U OR G.

**Impact:** LLM could be confused about actual mana availability, potentially making suboptimal plays.

**Fix:** Changed mana display format in coach.py:1108-1176
- Old format: `Mana: 1 (U:1 G:1)` - misleading!
- New format: `Mana: 1 (sources: {U/G})` - clear!
- Now tracks individual sources and shows dual lands as `{U/G}` to indicate "one source, either color"

**Example outputs:**
- 1 Temple of Mystery: `Mana: 1 (sources: {U/G})`
- 2 Islands: `Mana: 2 (sources: U U)`
- 1 Plains, 1 Breeding Pool: `Mana: 2 (sources: W {U/G})`

### Bug #2: Advisor Suggesting Unnecessary Life Payment
**Problem:** Advisor told user to pay 2 life for Breeding Pool to enter untapped "to cast Llanowar Elves", but Llanowar Elves was already tagged [S,OK] meaning it was castable with current mana from Temple of Mystery.

**Root Cause:** System prompt didn't explicitly tell LLM "don't waste resources when cards are already castable."

**Fix:** Strengthened system prompts in coach.py:656-733
- Added explicit rule: "If a card shows [OK], you already have enough mana. Don't suggest paying extra life/resources for more mana."
- Added resource efficiency principle: "RESOURCE EFFICIENCY: Don't waste life or mana. If you can cast a spell with current mana, don't pay extra."
- Added explanation of sources display: "The 'sources:' display shows what mana EACH source can produce"

### Bug #3: Suggesting Illegal "Flash" Actions
**Problem:** Advisor suggested "flash in Badgermole Cub or Leyline Weaver" during opponent's turn, but neither card has flash and only "Wait" was in the Legal: actions list.

**Root Cause:** LLM hallucinating actions not in the Legal: list, not following the constraint strictly enough.

**Fix:** Strengthened both system prompts with explicit constraints:
- Added: "NEVER suggest actions not in the Legal: line. If you want to cast a spell, it MUST appear as 'Cast [card name]' in Legal:."
- Added: "Do NOT hallucinate actions like 'flash in' or 'hold up' unless they are explicitly legal actions."
- Added: "NEVER suggest actions not in Legal:. If you want to 'flash in' a creature, it MUST show 'Cast [creature]' in Legal:."
- Clarified timing: "Cards marked [SORCERY SPEED] or [S] can ONLY be cast during YOUR Main phase with empty stack"

### Bug #4: Confusing Castability Logic (Documentation Improvement)
**Issue:** The castability check was actually working correctly, but needed better documentation to prevent future confusion.

**Fix:** Added detailed comments in coach.py:1397-1417 explaining:
- Why the logic is correct despite dual land color counting
- How total_mana check happens first (ensuring enough sources)
- How color check happens second (ensuring color requirements can be met)
- Why dual lands can count toward multiple colors in the color check

## Testing Recommendations

1. **Test dual land scenarios:**
   - 1 Temple of Mystery → should show `Mana: 1 (sources: {U/G})`
   - 2 dual lands → should show `Mana: 2 (sources: {U/G} {G/R})`
   - Mix of basics and duals → should show clearly

2. **Test resource efficiency:**
   - Card tagged [S,OK] with shock land in hand
   - Advisor should NOT suggest paying life unless necessary
   - Should recognize when current mana is sufficient

3. **Test Legal: action adherence:**
   - During opponent's turn, only instants/flash allowed
   - Advisor should ONLY suggest actions from Legal: list
   - No hallucinated "flash in" suggestions for sorcery-speed cards

4. **Test with the original bug scenario:**
   - Turn 3, Temple of Mystery on board (1 mana available)
   - Llanowar Elves {G} in hand should show [S,OK]
   - Breeding Pool in hand
   - Advisor should suggest: "Play Breeding Pool, let it enter tapped. You already have enough mana to cast Llanowar Elves."

## Files Modified

- `src/arenamcp/coach.py`:
  - Lines 1108-1176: Mana calculation and display
  - Lines 656-680: DEFAULT_SYSTEM_PROMPT critical rules
  - Lines 724-744: CONCISE_SYSTEM_PROMPT rules
  - Lines 1397-1417: Castability check with improved comments

## Backward Compatibility

✅ All changes are backward compatible:
- Mana pool internal calculations unchanged (still correct)
- Only display format changed (clearer for LLM)
- System prompts strengthened (more explicit, not fundamentally changed)
- Castability tagging logic unchanged (was already correct)

## Performance Impact

✅ Negligible performance impact:
- Mana source tracking adds minimal overhead (one list)
- No additional API calls or complex calculations
- System prompt slightly longer but still well within token budgets
